---
title: "Re-analysis of NicheNet dataset"
---
  
```{r setup, echo=F,message=F,warning=F}
library(colorspace)
library(scales)
source("~/Dropbox/GDB/line2user.R")
```


# Using all data

```{r all_load_data, echo=F,message=F,warning=F}
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_all_dat.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_all_corr.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_all_DEovlp.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_all_DEmeanlfc.RData")
```

## Correlation

```{r all_corr_boxplot, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
par(mar=c(5,3,1,1),mgp=2:0)
temp <- unlist(sapply(nn_ligands,
                      function(X) 
                        list(ALL=corr_all[[X]],
                             CT=corr_ct[[X]],
                             DS=corr_ds[[X]]),
                      simplify=F),recursive=F)
plot(NA,NA,xlim=c(0,length(temp)+1),ylim=range(temp),xaxt="n",xaxs="i",
     xlab=NA,ylab="Spearman correlation of logFC")
boxplot(temp,xaxt="n",yaxt="n",add=T)
mtext(names(temp),side=1,line=0.1,at=seq_along(temp),adj=1,las=3,cex=0.8)
abline(v=seq(3.5,by=3,length.out=length(nn_ligands)-1),col="grey50")

rm(list=grep("^temp",ls(),value=T))
```

```{r corr_boxplot_compTS, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
par(mfrow=c(1,2),mar=c(3,3,1,1),mgp=2:0)
boxplot(list(ALL=unlist(corr_all),CT=unlist(corr_ct),DS=unlist(corr_ds)),
        ylab="Spearman correlation of logFC")

corr_all_nts <- corr_all_ts <- list()
for (LIG in names(corr_all)) {
  temp_ts <- sapply(strsplit(names(corr_all[[LIG]]),".",fixed=T),
                    function(X) all(DSinfo[[LIG]][X,"time_series"]))
  corr_all_ts[[LIG]] <- corr_all[[LIG]][temp_ts]
  corr_all_nts[[LIG]] <- corr_all[[LIG]][!temp_ts]
}
boxplot(list(ALL_nTS=unlist(corr_all_nts),ALL_TS=unlist(corr_all_ts),
             CT=unlist(corr_ct),DS=unlist(corr_ds)))

rm(list=c("LIG",grep("^temp",ls(),value=T)))
```
Despite the goofiness of the time-series logFC calculations (all are positive?), there's no discernible difference in correlation of logFC within time-series experiments vs non-time-series.  

Note that calculating correlation between time-series and non-TS logFC values is chaos, so those comparisons are skipped in the following figure.  

### Final correlation figure

```{r corr_plot, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
temp_order <- names(sort(sapply(unique(c(names(corr_all),names(corr_ct),names(corr_ds))),
                                function(X) mean(c(corr_all[[X]],corr_ct[[X]],corr_ds[[X]])))))
lig_col <- qualitative_hcl(length(nn_ligands),palette="dark3",alpha=0.5)
temp_colnames <- c(temp_order,nn_ligands[!nn_ligands %in% temp_order])
names(lig_col) <- temp_colnames[unlist(sapply(seq(1,ceiling(length(nn_ligands)/2)),
                                              function(X) c(X,X + ceiling(length(nn_ligands)/2)),
                                              simplify=F))]
temp_corr <- list(ALL=corr_all[temp_order[temp_order %in% names(corr_all)]],
               CT=corr_ct[temp_order[temp_order %in% names(corr_ct)]],
               DS=corr_ds[temp_order[temp_order %in% names(corr_ds)]])
temp_lig <- sapply(strsplit(names(unlist(temp_corr,recursive=F)),".",fixed=T),"[[",2)


layout(rbind(1:2),widths=c(4,1))

par(mar=c(5,3,1,0.5),mgp=2:0)
plot(NA,NA,xlim=c(1,length(unlist(temp_corr,recursive=F))),ylim=range(temp_corr),
     xaxt="n",xlab=NA,ylab="Spearman correlation of log(fold-change)")
abline(v=cumsum(sapply(temp_corr,length)[1:2]) + 0.5,col="grey70")
abline(h=0,lty=2,col="grey50")
temp_x <- unlist(mapply(rep,x=seq_along(unlist(temp_corr,recursive=F)),
                        times=sapply(unlist(temp_corr,recursive=F),length)))
points(x=jitter(temp_x,amount=0.2),y=unlist(temp_corr),
       pch=19,col=lig_col[temp_lig][temp_x])
mtext(temp_lig,side=1,line=0.1,at=seq_along(temp_lig),las=3,col=alpha(lig_col[temp_lig],1))

segments(x0=c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
         x1=cumsum(sapply(temp_corr,length)) + 0.25,
         y0=line2user(4,1),y1=line2user(4,1),xpd=NA,lwd=2)
segments(x0=c(c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
              cumsum(sapply(temp_corr,length)) + 0.25),
         x1=c(c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
              cumsum(sapply(temp_corr,length)) + 0.25),
         y0=line2user(4,1),y1=line2user(3.8,1),xpd=NA,lwd=2)
mtext(c("Pairwise across cell types / labs","Within same cell type","Same lab"),
      at=0.5 + cumsum(sapply(temp_corr,length)) - sapply(temp_corr,length) / 2,
      side=1,line=4)


par(mar=c(5,0,1,3))
boxplot(list(ALL=unlist(corr_all),CT=unlist(corr_ct),DS=unlist(corr_ds)),
        xaxt="n",xlab=NA,yaxt="n",ylab=NA)
axis(4)
mtext("Spearman correlation of log(fold-change)",side=4,line=2)
mtext(c("Across all","Cell type","Lab"),side=1,line=0.1,at=1:3,las=3)

mtext(paste0("p=",c(signif(wilcox.test(unlist(corr_all),unlist(corr_ct))$p.value,2),
                      signif(wilcox.test(unlist(corr_ct),unlist(corr_ds))$p.value,2))),
      side=1,line=-0.1,at=c(1.5,2.5),las=3,adj=0,cex=0.7)

rm(list=grep("^temp",ls(),value=T))
```



## Differential gene expression

Differentially expressed genes were determined by logFC >= 1 and FDR <= 0.1 (as in Browaeys *et al.*, 2020).  This figure shows number of DE genes overlapping across all datasets testing the same ligand vs. datasets testing the same ligand in the same cell type vs. datasets from the same accession number (and same ligand / cell type).  P-values for overlap (y-axis) were determined after determining probability of overlapping DE genes by chance through bootstrapping.

```{r diffexp_boxplot, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
par(mar=c(1.5,3,1,1),mgp=2:0)
temp_bxp <- list(ALL=-log10(unlist(P_all)),
                 CT=-log10(unlist(P_ct)),
                 DS=-log10(unlist(P_ds)))
boxplot(temp_bxp,ylim=range(temp_bxp),outline=F,
        ylab="-log10(P # DE overlapping by chance)",xaxt="n")
mtext(c("Pairwise across cell types / labs","Within same cell type","Same lab"),
      side=1,line=0.1,at=1:3)
temp <- c("P_all","P_ct","P_ds")
for (X in temp) {
  temp_DE <- -log10(unlist(get(X)))
  names(temp_DE) <- unlist(mapply(rep,x=names(get(X)),times=sapply(get(X),length)))
  temp_DE <- sort(temp_DE)
  temp_x <- seq(which(temp == X) - 0.3,which(temp == X) + 0.3,length.out=length(temp_DE))
  points(temp_x,temp_DE,pch=19,col=lig_col[names(temp_DE)])
  Z <- temp_DE >= -log10(0.05)
  if (!any(Z)) { 
    Z <- temp_DE > 0
  }
  if (any(Z)) { 
    text(temp_x[Z],temp_DE[Z],pos=c(2,4),
         labels=names(temp_DE)[Z],font=2,
         col=alpha(lig_col[names(temp_DE)[Z]],1))
  }
}
mtext(paste("p =",c(signif(wilcox.test(unlist(P_all),unlist(P_ct))$p.value,2),
                    signif(wilcox.test(unlist(P_ct),unlist(P_ds))$p.value,2))),
      side=3,line=-0.9,at=c(1.5,2.5))

rm(list=c("X","Z",grep("^temp",ls(),value=T)))
```

```{r diffexp_boxplot_v2, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
temp_y <- lapply(c("P_all","P_ct","P_ds"),function(X) {
  temp <- -log10(unlist(get(X)))
  names(temp) <- sapply(strsplit(names(unlist(get(X))),".",fixed=T),"[[",1)
  return(temp)
})
temp_x <- sapply(list(ALL=de_all,CT=de_ct,DS=de_ds),function(DE)
  sapply(unlist(DE,recursive=F,use.names=F),length),simplify=F)

par(mfrow=c(1,4),mar=c(5,4,1,0.5),mgp=2:0)
boxplot(temp_y,ylim=range(temp_y),outline=T,xaxt="n",yaxt="n",ylab=NA)
text(c(1.5,2.5),line2user(-0.2,3),srt=90,adj=1,cex=1.2,
     labels=paste("p =",c(signif(wilcox.test(unlist(P_all),unlist(P_ct))$p.value,2),
                          signif(wilcox.test(unlist(P_ct),unlist(P_ds))$p.value,2))))
axis(2,cex.axis=1.2)
mtext("-log10(P # DE overlapping by chance)",side=2,line=2.5)
text(1:3,line2user(0.5,1),xpd=NA,srt=45,adj=1,cex=1.4,font=2,
     labels=c("Across all","Cell type","Lab"))

par(mar=c(5,0,1,0.5))
temp <- mapply(function(X,Y,N) {
  plot(NA,NA,xlim=range(X),ylim=range(temp_y),
       xaxt="n",yaxt="n",ylab=NA,xlab=NA)
  temp_X <- X; temp_Y <- Y
  temp_X[temp_X == 0] <- -abs(jitter(temp_X[temp_X == 0],amount=abs(par("usr")[1]) / 2))
  temp_Y[temp_Y == 0] <- -abs(jitter(temp_Y[temp_Y == 0],amount=abs(par("usr")[3]) / 2))
  points(temp_X,temp_Y,pch=19,cex=1.5,
         col=lig_col[names(temp_Y)])
  Z <- Y >= -log10(0.05)
  if (!any(Z)) { Z <- Y > 0 }
  temp_labels <- scClustViz::spreadLabels2(temp_X[Z],temp_Y[Z],label=names(temp_Y)[Z],
                                           str.cex=1.5,str.font=2)
  text(temp_labels,labels=names(temp_Y)[Z],cex=1.2,font=2,
       col=alpha(lig_col[names(temp_Y)[Z]],1))
  axis(1,cex.axis=1.2)
  mtext("# overlapping DE",side=1,line=2.5)
  mtext(N,side=1,line=4,font=2)
},X=temp_x,Y=temp_y,N=c("Pairwise across cell types / labs","Within same cell type","Same lab"))
```




```{r DEdotplot_fx, echo=F,message=F,warning=F}
DE_dotplot <- function(LIG,GENES,exclude=c()) {
  temp_DS <- rownames(DSinfo[[LIG]])
  temp_DS <- temp_DS[!temp_DS %in% exclude]
  
  temp_ord_ds <- hclust(dist(t(nn_lig_rep[[LIG]]$lfc[GENES,temp_DS])),"ward.D2")$order
  temp_ord_gene <- hclust(dist(nn_lig_rep[[LIG]]$lfc[GENES,temp_DS]),"ward.D2")$order
  
  CTcol <- qualitative_hcl(length(unique(DSinfo[[LIG]]$cell_type)),palette="dark3")
  names(CTcol) <- unique(DSinfo[[LIG]]$cell_type)
  
  ogLFC <- nn_lig_rep[[LIG]]$lfc[GENES,temp_DS]
  ogLFC <- ogLFC[temp_ord_gene,temp_ord_ds]
  temp_dsname <- DSinfo[[LIG]][colnames(ogLFC),"CtAcc"]
  temp_dsname[DSinfo[[LIG]][colnames(ogLFC),"time_series"]] <-
    paste(temp_dsname[DSinfo[[LIG]][colnames(ogLFC),"time_series"]],"*")
  temp_labelcol <- CTcol[DSinfo[[LIG]][colnames(ogLFC),"cell_type"]]
  names(temp_labelcol) <- colnames(ogLFC) <- temp_dsname
  if (!is.null(mean_lfc[[LIG]])) {
    LFC <- cbind(ogLFC,rep(0,nrow(ogLFC)))
    temp_labelcol <- append(temp_labelcol,"black")
    if (!is.null(mean_lfc[[LIG]]$nts_lfc)) {
      LFC <- cbind(LFC,"Mean (no *)"=mean_lfc[[LIG]][GENES[temp_ord_gene],"nts_lfc"])
      temp_labelcol <- append(temp_labelcol,"black")
    }
    if (!is.null(mean_lfc[[LIG]]$ts_lfc)) {
      LFC <- cbind(LFC,"Mean (only *)"=mean_lfc[[LIG]][GENES[temp_ord_gene],"ts_lfc"])
      temp_labelcol <- append(temp_labelcol,"black")
    }
    if (!is.null(mean_lfc_CT[[LIG]])){
      LFC <- cbind(LFC,sapply(mean_lfc_CT[[LIG]],function(X) X[GENES[temp_ord_gene],"lfc"]))
      temp_labelcol <- append(temp_labelcol,CTcol[names(mean_lfc_CT[[LIG]])])
    }
    if (!is.null(mean_lfc_DS[[LIG]])){
      LFC <- cbind(LFC,sapply(mean_lfc_DS[[LIG]],function(X) X[GENES[temp_ord_gene],"lfc"]))
      temp_labelcol <- append(temp_labelcol,temp_labelcol[names(mean_lfc_DS[[LIG]])])
    }
  } else {
    LFC <- ogLFC
  }
  LFC <- t(matrix(
    cut(c(-1,1,as.vector(LFC / max(LFC))),
        breaks=1000,labels=F)[-1*(1:2)],
    nrow(LFC)))
  
  
  ogFDR <- nn_lig_rep[[LIG]]$qval[GENES,temp_DS]
  ogFDR <- ogFDR[temp_ord_gene,temp_ord_ds]
  colnames(ogFDR) <- temp_dsname
  if (!is.null(mean_lfc[[LIG]])) {
    FDR <- cbind(ogFDR,rep(1,nrow(ogFDR)))
    if (!is.null(mean_lfc[[LIG]]$nts_lfc)) {
      FDR <- cbind(FDR,"Mean (no *)"=mean_lfc[[LIG]][GENES[temp_ord_gene],"nts_fdr"])
    }
    if (!is.null(mean_lfc[[LIG]]$ts_lfc)) {
      FDR <- cbind(FDR,"Mean (only *)"=mean_lfc[[LIG]][GENES[temp_ord_gene],"ts_fdr"])
    }
    if (!is.null(mean_lfc_CT[[LIG]])){
      FDR <- cbind(FDR,sapply(mean_lfc_CT[[LIG]],function(X) X[GENES[temp_ord_gene],"fdr"]))
    }
    if (!is.null(mean_lfc_DS[[LIG]])){
      FDR <- cbind(FDR,sapply(mean_lfc_DS[[LIG]],function(X) X[GENES[temp_ord_gene],"fdr"]))
    }
  } else {
    FDR <- ogFDR
  }
  FDR <- -log10(FDR)
  FDR[FDR > 2] <- 2
  FDR <- t(FDR / max(FDR))
  FDR[FDR == 0] <- NA
  
  if (!any(DSinfo[[LIG]][temp_DS,"time_series"])) {
    rownames(LFC)[rownames(LFC) == "Mean (no *)"] <- "Mean"
    rownames(FDR)[rownames(FDR) == "Mean (no *)"] <- "Mean"
  }
  
  DE <- t(ogLFC >= 1 & ogFDR <= 0.1)
  if (!is.null(mean_lfc[[LIG]])) {
    DE <- rbind(DE,rep(F,ncol(DE)))
    if (!is.null(mean_lfc[[LIG]]$nts_fdr)) {
      DE <- rbind(DE,mean_lfc[[LIG]][GENES[temp_ord_gene],"nts_lfc"] >= 1 & 
                    mean_lfc[[LIG]][GENES[temp_ord_gene],"nts_fdr"] <= 0.1)
    }
    if (!is.null(mean_lfc[[LIG]]$ts_fdr)) {
      DE <- rbind(DE,mean_lfc[[LIG]][GENES[temp_ord_gene],"ts_lfc"] >= 1 & 
                    mean_lfc[[LIG]][GENES[temp_ord_gene],"ts_fdr"] <= 0.1)
    }
    if (!is.null(mean_lfc_CT[[LIG]])){
      DE <- rbind(DE,
                  t(sapply(mean_lfc_CT[[LIG]],function(X) 
                    X[GENES[temp_ord_gene],"lfc"] >= 1 & 
                      X[GENES[temp_ord_gene],"fdr"] <= 0.1)))
    }
    if (!is.null(mean_lfc_DS[[LIG]])){
      DE <- rbind(DE,
                  t(sapply(mean_lfc_DS[[LIG]],function(X) 
                    X[GENES[temp_ord_gene],"lfc"] >= 1 & 
                      X[GENES[temp_ord_gene],"fdr"] <= 0.1)))
    }
  }
  

  par(mar=c(8,7,1,1),mgp=2:0)
  plot(x=NULL,y=NULL,xlim=c(0.5,nrow(LFC) + .5),ylim=c(0.5,ncol(LFC) + .5),
       xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA,bty="n",asp=1)
  # abline(v=1:nrow(LFC),col="grey90")
  # abline(h=1:ncol(LFC),col="grey90")
  
  temp_FG <- temp_BG <- diverging_hcl(1000,palette="Blue-Red3")[as.vector(LFC)]
  temp_FG[as.vector(DE)] <- "mediumseagreen"
  symbols(x=rep(1:nrow(FDR),ncol(FDR)),
          y=as.vector(sapply(1:ncol(FDR),function(X) rep(X,nrow(FDR)))),
          circles=as.vector(FDR)/2,inches=F,add=T,xpd=NA,
          fg=temp_FG,bg=temp_BG)

  mtext(colnames(FDR),side=2,at=seq_along(colnames(FDR)),las=2,line=0.1,cex=0.8)
  text(x=seq_along(rownames(FDR)),y=rep(par("usr")[3] - 0.5,nrow(FDR)),
       labels=rownames(FDR),col=temp_labelcol,xpd=NA,adj=1,srt=45,cex=0.8)
  if (any(DSinfo[[LIG]][temp_DS,"time_series"])) {
    text(x=0,y=par("usr")[3] - 0.5,labels="* Time-series dataset",
         xpd=NA,adj=1,srt=45,cex=0.8)
  }
  
  temp_yh <- par("usr")[4] - par("usr")[3]
  segments(x0=rep(line2user(5,2),1000),x1=rep(line2user(4,2),1000),
           y0=seq(0.6 * temp_yh + par("usr")[3],
                  0.9 * temp_yh + par("usr")[3],
                  length.out=1000),
           y1=seq(0.6 * temp_yh + par("usr")[3],
                  0.9 * temp_yh + par("usr")[3],
                  length.out=1000),
           xpd=NA,col=diverging_hcl(1000,palette="Blue-Red3"))
  rect(xleft=line2user(5,2),xright=line2user(4,2),
       ytop=0.9 * temp_yh + par("usr")[3],
       ybottom=(((0.9 - 0.75) * (1 / max(ogLFC))) + 0.75) * temp_yh + par("usr")[3],
       xpd=NA,border="mediumseagreen")
  mtext(c(signif(max(abs(ogLFC)),2),"logFC",-1 * signif(max(abs(ogLFC)),2)),
        side=2,line=c(4,5.1,4),adj=c(-0.1,0.5,1.1),
        at=c(0.9,0.75,0.6) * temp_yh + par("usr")[3])
  
  temp_q <- rev(c(0.5,0.2,0.1,0.05,0.01))
  symbols(x=rep(line2user(4.5,2),length(temp_q)),
          y=seq(0.4 * temp_yh + par("usr")[3],
                by=-1.5,length.out=length(temp_q)),
          circles=-log10(temp_q)/4,inches=F,add=T,xpd=NA,
          fg=ifelse(temp_q <= 0.1,"mediumseagreen","black"))
  mtext(c(paste0("\u2264",temp_q[1] * 100,"%"),
          paste0(temp_q[2:5] * 100,"%")),
        side=2,line=5,cex=0.8,
        at=seq(0.4 * temp_yh + par("usr")[3],
               by=-1.5,length.out=length(temp_q)))
  mtext("FDR",side=2,line=5.8,
        at=0.4 * temp_yh + par("usr")[3] - 3)
  
  mtext(LIG,side=3,line=-0.5,at=line2user(4.5,2),font=2,cex=1.5)
}


DE_dotplot_forCMap <- function(ogFDR,MAIN) {
  FDR <- ogFDR[,colnames(ogFDR) %in% names(mean_lfc)]
  FDR <- FDR[apply(FDR,1,function(X) any(X <= 0.1)),,drop=F]
  # temp_hROW <- hclust(dist(t(FDR)),method="ward.D2") 
  temp_hROW <- list(order=order(colnames(FDR),decreasing=T))
  temp_hGENE <- hclust(dist(FDR),method="ward.D2")
  FDR <- FDR[temp_hGENE$order,temp_hROW$order]
  FDR <- -log10(FDR)
  FDR[FDR > 2] <- 2
  FDR <- FDR / max(FDR)
  FDR[FDR == 0] <- NA
  
  ogZS <- sapply(colnames(FDR),function(LIG)
    rowMeans(lvl4_data@mat[rownames(FDR),lvl4_data@cdesc$pert_iname == LIG]))
  ZS <- matrix(cut(c(-1,1,as.vector(ogZS / max(abs(ogZS)))),
                   breaks=1000,labels=F)[-(1:2)],nrow=nrow(ogZS))
  
  
  par(mar=c(5,7,2,1),mgp=2:0)
  plot(x=NULL,y=NULL,xlim=c(0.5,nrow(FDR) + .5),ylim=c(0.5,ncol(FDR) + .5),
       xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA,bty="n",asp=1)
  abline(h=1:ncol(FDR),col="grey90")
  symbols(x=rep(1:nrow(FDR),ncol(FDR)),
          y=as.vector(sapply(1:ncol(FDR),function(X) rep(X,nrow(FDR)))),
          circles=as.vector(FDR)/2,inches=F,add=T,xpd=NA,
          fg=diverging_hcl(1000,palette="Blue-Red3")[as.vector(ZS)],
          bg=diverging_hcl(1000,palette="Blue-Red3")[as.vector(ZS)])
  mtext(colnames(FDR),side=2,at=seq_along(colnames(FDR)),las=2,line=0.1,cex=0.8)
  mtext("Ligands",side=2,line=2.5)
  mtext(lvl4_data@rdesc[rownames(FDR),"pr_gene_symbol"],
        side=1,las=2,at=1:nrow(FDR),line=0.1,cex=0.8)
  mtext("Genes differentially expressed",side=1,line=3.5)
  
  temp_yh <- par("usr")[4] - par("usr")[3]
  segments(x0=rep(line2user(5,2),1000),x1=rep(line2user(4,2),1000),
           y0=seq(0.6 * temp_yh + par("usr")[3],
                  0.9 * temp_yh + par("usr")[3],
                  length.out=1000),
           y1=seq(0.6 * temp_yh + par("usr")[3],
                  0.9 * temp_yh + par("usr")[3],
                  length.out=1000),
           xpd=NA,col=diverging_hcl(1000,palette="Blue-Red3"))
  mtext(c(signif(max(abs(ogZS)),2),"Z-score",-1 * signif(max(abs(ogZS)),2)),
        side=2,line=c(4,5.1,4),adj=c(-0.1,0.5,1.1),
        at=c(0.9,0.75,0.6) * temp_yh + par("usr")[3])
  
  temp_q <- rev(c(0.5,0.2,0.1,0.05,0.01))
  symbols(x=rep(line2user(4.5,2),length(temp_q)),
          y=seq(0.4 * temp_yh + par("usr")[3],
                by=-1.5,length.out=length(temp_q)),
          circles=-log10(temp_q)/4,inches=F,add=T,xpd=NA,
          fg="black")
  mtext(c(paste0("\u2264",temp_q[1] * 100,"%"),
          paste0(temp_q[2:5] * 100,"%")),
        side=2,line=5,cex=0.8,
        at=seq(0.4 * temp_yh + par("usr")[3],
               by=-1.5,length.out=length(temp_q)))
  mtext("FDR",side=2,line=5.8,
        at=0.4 * temp_yh + par("usr")[3] - 3)
  
  mtext(MAIN,side=3,line=0.5,font=2,cex=1.2)
}
```

Similar to CMap analyses, took mean LogFC across all samples treated with the same ligand, or same ligand in the same cell line, or from the same accession number (and same ligand / cell line).  

```{r mean_LFC_hist, echo=F,message=F,warning=F,fig.height=6,fig.width=5}
temp_LFC <- list(ALL=unlist(sapply(mean_lfc,"[[","nts_lfc")),
                 CT=unlist(sapply(unlist(mean_lfc_CT,recursive=F),"[[","lfc")),
                 DS=unlist(sapply(unlist(mean_lfc_DS,recursive=F),"[[","lfc")))
temp_range <- range(unlist(temp_LFC))

temp_FDR <- list(ALL=unlist(sapply(mean_lfc,"[[","nts_fdr")),
                 CT=unlist(sapply(unlist(mean_lfc_CT,recursive=F),"[[","fdr")),
                 DS=unlist(sapply(unlist(mean_lfc_DS,recursive=F),"[[","fdr")))


par(mfrow=c(3,1),mar=c(4,3,1,1),mgp=2:0)
for (X in names(temp_FDR)) {
  temp_main <- switch(X,
                      ALL="Mean LogFC per ligand",
                      CT="By cell type",
                      DS="By dataset")
  
  # hist(temp_LFC[[X]],freq=F,xlim=temp_range,xlab="LogFC",main=temp_main)

  hist(temp_FDR[[X]],freq=F,xlab="FDR",main=temp_main)
  abline(v=mean(temp_FDR[[X]]),lwd=2,col="red")
  if (X == "ALL") {
      legend("topleft",bty="n",lwd=2,col="red",legend="Mean")
  } else {
    legend("topleft",bty="n",lwd=c(2,NA,NA),col=c("red",NA,NA),
           legend=c("Mean","Wilcoxon rank-sum",
                    paste("p =",signif(wilcox.test(temp_FDR[[X]],temp_FDR[[Y]])$p.value,2))))
  }
  # hist(-log10(temp_FDR[[X]]),freq=F,xlim=c(0,temp_max),xlab="-log10(FDR)",main=temp_main)
  # abline(v=mean(-log10(temp_FDR[[X]])),lwd=2,col="red")
  # legend("topright",bty="n",legend="Mean",lwd=2,col="red")
  Y <- X
}

```


Connectivity Map data from the same set of ligands assayed in multiple experiments from the NicheNet datasets.

```{r CMap_DE_load, echo=F,message=F,warning=F,fig.height=5,fig.width=9}
require(cmapR)
temp <- load("~/Dropbox/GDB_archive/CMapCorr_files/lvl4_inputs_allgenes.RData")
lvl4_data <- lvl4_data_all
rm(list=temp)

load("~/Dropbox/GDB_archive/CMapCorr_files/lig295_DE_allgenes_lig_FDR.RData")
FDRinf <- FDR_lig
load("~/Dropbox/GDB_archive/CMapCorr_files/lig295_DE_lig_FDR.RData")
FDRass <- FDR_lig
rm(FDR_lig)

par(mfrow=c(1,2))
DE_dotplot_forCMap(FDRass,"CMap (assayed genes only)")
DE_dotplot_forCMap(FDRinf,"CMap (including inferred)")

```


```{r DE_dot, echo=F,message=F,warning=F}
for (LIG in nn_ligands) {
  # print(paste(LIG,which(nn_ligands == LIG),"/",length(nn_ligands)))
  
  temp_genes <- Reduce(union,nn_DE[[LIG]])
  if (LIG %in% colnames(FDRinf)) {
    temp_cmapgenes <- unique(
      lvl4_data@rdesc[c(rownames(FDRass)[FDRass[,LIG] <= 0.1],
                        rownames(FDRinf)[FDRinf[,LIG] <= 0.1]),"pr_gene_symbol"]
    )
    temp_cmapgenes <- temp_cmapgenes[temp_cmapgenes %in% temp_genes]
  } else {
    temp_cmapgenes <- character()
  }
  # print(paste("cmapgenes =",length(temp_cmapgenes)))
  
  if (!is.null(mean_lfc[[LIG]])) {
    temp_meanhits <- rownames(mean_lfc[[LIG]])[
      apply(mean_lfc[[LIG]][,colnames(mean_lfc[[LIG]]) %in% c("nts_fdr","ts_fdr"),drop=F],1,
            function(X) any(X <= 0.1))
    ]
    # print(paste("mean_lfc =",length(temp_meanhits)))
    if (length(temp_meanhits) < 1) {
      temp_meanhits <- rownames(mean_lfc[[LIG]])[c(which.min(mean_lfc[[LIG]]$nts_fdr),
                                                   which.min(mean_lfc[[LIG]]$ts_fdr))]
    }
  } else {
    temp_meanhits <- character()
  }
  
  temp_DEoverlap <- rowSums(sapply(nn_DE[[LIG]],function(X) temp_genes %in% X))
  # print(table(temp_DEoverlap))
  if (sum(temp_DEoverlap == max(temp_DEoverlap)) > 50) {
    temp_commonDE <- names(sort(rowSums(
      nn_lig_rep[[LIG]]$qval[temp_genes[temp_DEoverlap == max(temp_DEoverlap)],]
    ))[1:50])
  } else if (length(c(temp_meanhits,temp_cmapgenes)) +
             sum(temp_DEoverlap == max(temp_DEoverlap)) < 15) {
    temp_commonDE <- c(temp_genes[temp_DEoverlap == max(temp_DEoverlap)],
                       names(sort(rowSums(nn_lig_rep[[LIG]]$qval[temp_genes,]))[1:10]))
  } else {
    temp_commonDE <- temp_genes[temp_DEoverlap == max(temp_DEoverlap)]
  }

  GENES <- unique(c(temp_commonDE,temp_meanhits,temp_cmapgenes))
  GENES <- GENES[!is.na(GENES)]
  # print(length(GENES))
  # print("")
  
  temp_Ylen <- length(GENES)
  temp_Xlen <- nrow(DSinfo[[LIG]]) + 
    as.integer(!is.null(mean_lfc[[LIG]])) + 
    length(mean_lfc[[LIG]][1,]) / 3 +
    length(mean_lfc_CT[[LIG]]) +
    length(mean_lfc_DS[[LIG]])
  
  Sys.sleep(0.1)
  png(paste0("~/Dropbox/GDB/CMapCorr/docs/output_figs/NN_",LIG,".png"),
      width=temp_Xlen * 0.2 + 1.6,height=temp_Ylen * 0.2 + 1.8,
      units="in",res=150)
  DE_dotplot(LIG,GENES)
  dev.off()
  
  rm(list=c("GENES",grep("^temp",ls(),value=T)))
}
```


```{r DE_dot_noTS, echo=F,message=F,warning=F}
for (LIG in nn_ligands) {
  if (sum(!DSinfo[[LIG]]$time_series) < 2) { next }
  # print(paste(LIG,which(nn_ligands == LIG),"/",length(nn_ligands)))
  
  temp_genes <- Reduce(union,nn_DE[[LIG]])
  if (LIG %in% colnames(FDRinf)) {
    temp_cmapgenes <- unique(
      lvl4_data@rdesc[c(rownames(FDRass)[FDRass[,LIG] <= 0.1],
                        rownames(FDRinf)[FDRinf[,LIG] <= 0.1]),"pr_gene_symbol"]
    )
    temp_cmapgenes <- temp_cmapgenes[temp_cmapgenes %in% temp_genes]
  } else {
    temp_cmapgenes <- character()
  }
  # print(paste("cmapgenes =",length(temp_cmapgenes)))
  
  if (!is.null(mean_lfc[[LIG]]$nts_fdr)) {
    temp_meanhits <- rownames(mean_lfc[[LIG]])[mean_lfc[[LIG]]$nts_fdr <= 0.1]
    # print(paste("mean_lfc =",length(temp_meanhits)))
    if (length(temp_meanhits) < 1) {
      temp_meanhits <- rownames(mean_lfc[[LIG]])[which.min(mean_lfc[[LIG]]$nts_fdr)]
    }
  } else {
    temp_meanhits <- character()
  }
  mean_lfc[[LIG]] <- mean_lfc[[LIG]][,!grepl("^ts",colnames(mean_lfc[[LIG]]))]
  
  temp_DEoverlap <- rowSums(sapply(nn_DE[[LIG]],function(X) temp_genes %in% X))
  # print(table(temp_DEoverlap))
  if (sum(temp_DEoverlap == max(temp_DEoverlap)) > 50) {
    temp_commonDE <- names(sort(rowSums(
      nn_lig_rep[[LIG]]$qval[temp_genes[temp_DEoverlap == max(temp_DEoverlap)],]
    ))[1:50])
  } else if (length(c(temp_meanhits,temp_cmapgenes)) +
             sum(temp_DEoverlap == max(temp_DEoverlap)) < 15) {
    temp_commonDE <- c(temp_genes[temp_DEoverlap == max(temp_DEoverlap)],
                       names(sort(rowSums(nn_lig_rep[[LIG]]$qval[temp_genes,]))[1:10]))
  } else {
    temp_commonDE <- temp_genes[temp_DEoverlap == max(temp_DEoverlap)]
  }

  GENES <- unique(c(temp_commonDE,temp_meanhits,temp_cmapgenes))
  GENES <- GENES[!is.na(GENES)]
  # print(length(GENES))
  # print("")
  
  temp_Ylen <- length(GENES)
  temp_Xlen <- nrow(DSinfo[[LIG]]) + 
    as.integer(!is.null(mean_lfc[[LIG]])) + 
    length(mean_lfc[[LIG]][1,]) / 3 +
    length(mean_lfc_CT[[LIG]]) +
    length(mean_lfc_DS[[LIG]])
  
  Sys.sleep(0.1)
  png(paste0("~/Dropbox/GDB/CMapCorr/docs/output_figs/NN_",LIG,"_noTS.png"),
      width=temp_Xlen * 0.2 + 1.6,height=temp_Ylen * 0.2 + 1.8,
      units="in",res=150)
  DE_dotplot(LIG,GENES,exclude=rownames(DSinfo[[LIG]])[DSinfo[[LIG]]$time_series])
  dev.off()
  
  rm(list=c("GENES",grep("^temp",ls(),value=T)))
}
```

Modified heatmaps showing logFC and FDR for selected genes from each sample from the NicheNet gold standard, as well as averages across all samples, all cell types, and all datasets where available.  The figure below is an example for TNF.  

```{r dotplot_links,echo=F,results="asis"}
temp_files <- list.files("docs/output_figs/",pattern="^NN")
for (LIG in sort(nn_ligands)) {
  if (!any(grepl(LIG,temp_files))) { next }
  cat("<p>")
  temp_ligfiles <- grep(paste0("_",LIG,"[._]"),temp_files,value=T)
  cat(paste0('<a href="output_figs/',temp_ligfiles[!grepl("noTS",temp_ligfiles)],'">',LIG,'</a>'))
  if (any(grepl("noTS",temp_ligfiles))) {
    cat(paste0('  -  <a href="output_figs/',
               temp_ligfiles[grepl("noTS",temp_ligfiles)],
               '">',LIG,' (no time-series)</a>'))
  }
  cat("</p>")
  cat("\n")
}

cat('<p><img src="output_figs/NN_TNF_noTS.png"/></p>')
```

****

```{r load_lvl5, echo=F,message=F,warning=F}
load("~/Dropbox/GDB_archive/CMapCorr_files/lvl5_inputs_allgenes.RData")
rm(lig16)

Y <- rownames(lvl5_data@cdesc)[lvl5_data@cdesc$pert_iname == "TNF"]
X <- rownames(lvl5_data@mat)[unique(apply(lvl5_data@mat[,Y],2,which.max))]



image(lvl5_data@mat[X,Y])

```



****

# After removing time-series data

```{r noTS_load_data, echo=F,message=F,warning=F}
rm(list=ls())

source("~/Dropbox/GDB/line2user.R")

load("~/Dropbox/GDB_archive/CMapCorr_files/NN_noTS_dat.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_noTS_corr.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_noTS_DEovlp.RData")
load("~/Dropbox/GDB_archive/CMapCorr_files/NN_noTS_DEmeanlfc.RData")
```

## Correlation


```{r noTS_corr_plot, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
temp_order <- names(sort(sapply(unique(c(names(corr_all),names(corr_ct),names(corr_ds))),
                                function(X) mean(c(corr_all[[X]],corr_ct[[X]],corr_ds[[X]])))))
lig_col <- qualitative_hcl(length(temp_order),palette="dark3",alpha=0.5)
names(lig_col) <- temp_order[unlist(sapply(1:5,function(X) c(X,X+5),simplify=F))]
temp_corr <- list(ALL=corr_all[temp_order[temp_order %in% names(corr_all)]],
               CT=corr_ct[temp_order[temp_order %in% names(corr_ct)]],
               DS=corr_ds[temp_order[temp_order %in% names(corr_ds)]])
temp_lig <- sapply(strsplit(names(unlist(temp_corr,recursive=F)),".",fixed=T),"[[",2)


layout(rbind(1:2),widths=c(4,1))

par(mar=c(5,3,1,0.5),mgp=2:0)
plot(NA,NA,xlim=c(1,length(unlist(temp_corr,recursive=F))),ylim=range(temp_corr),
     xaxt="n",xlab=NA,ylab="Spearman correlation of log(fold-change)")
abline(v=cumsum(sapply(temp_corr,length)[1:2]) + 0.5,col="grey70")
abline(h=0,lty=2,col="grey50")
temp_x <- unlist(mapply(rep,x=seq_along(unlist(temp_corr,recursive=F)),
                        times=sapply(unlist(temp_corr,recursive=F),length)))
points(x=jitter(temp_x,amount=0.2),y=unlist(temp_corr),
       pch=19,col=lig_col[temp_lig][temp_x])
mtext(temp_lig,side=1,line=0.1,at=seq_along(temp_lig),las=3,col=alpha(lig_col[temp_lig],1))

segments(x0=c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
         x1=cumsum(sapply(temp_corr,length)) + 0.25,
         y0=line2user(4,1),y1=line2user(4,1),xpd=NA,lwd=2)
segments(x0=c(c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
              cumsum(sapply(temp_corr,length)) + 0.25),
         x1=c(c(0,cumsum(sapply(temp_corr,length)[1:2])) + 0.75,
              cumsum(sapply(temp_corr,length)) + 0.25),
         y0=line2user(4,1),y1=line2user(3.8,1),xpd=NA,lwd=2)
mtext(c("Pairwise across cell types / labs","Within same cell type","Same lab"),
      at=0.5 + cumsum(sapply(temp_corr,length)) - sapply(temp_corr,length) / 2,
      side=1,line=4)


par(mar=c(5,0,1,3))
boxplot(list(ALL=unlist(corr_all),CT=unlist(corr_ct),DS=unlist(corr_ds)),
        xaxt="n",xlab=NA,yaxt="n",ylab=NA)
axis(4)
mtext("Spearman correlation of log(fold-change)",side=4,line=2)
mtext(c("Across all","Cell type","Lab"),side=1,line=0.1,at=1:3,las=3)

mtext(paste0("p=",c(signif(wilcox.test(unlist(corr_all),unlist(corr_ct))$p.value,2),
                      signif(wilcox.test(unlist(corr_ct),unlist(corr_ds))$p.value,2))),
      side=1,line=-0.1,at=c(1.5,2.5),las=3,adj=0,cex=0.7)

rm(list=grep("^temp",ls(),value=T))
```



## Differential gene expression

```{r noTS_diffexp_boxplot, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
par(mar=c(1.5,3,1,1),mgp=2:0)
temp_bxp <- list(ALL=-log10(unlist(P_all)),
                 CT=-log10(unlist(P_ct)),
                 DS=-log10(unlist(P_ds)))
boxplot(temp_bxp,ylim=range(temp_bxp),outline=F,
        ylab="-log10(P # DE overlapping by chance)",xaxt="n")
mtext(c("Pairwise across cell types / labs","Within same cell type","Same lab"),
      side=1,line=0.1,at=1:3)
temp <- c("P_all","P_ct","P_ds")
for (X in temp) {
  temp_DE <- -log10(unlist(get(X)))
  names(temp_DE) <- unlist(mapply(rep,x=names(get(X)),times=sapply(get(X),length)))
  temp_DE <- sort(temp_DE)
  temp_x <- seq(which(temp == X) - 0.3,which(temp == X) + 0.3,length.out=length(temp_DE))
  points(temp_x,temp_DE,pch=19,col=lig_col[names(temp_DE)])
  Z <- temp_DE >= -log10(0.05)
  if (!any(Z)) { 
    Z <- temp_DE > 0
  }
  if (any(Z)) { 
    text(temp_x[Z],temp_DE[Z],pos=c(2,4),
         labels=names(temp_DE)[Z],font=2,
         col=alpha(lig_col[names(temp_DE)[Z]],1))
  }
}
mtext(paste("p =",c(signif(wilcox.test(unlist(P_all),unlist(P_ct))$p.value,2),
                    signif(wilcox.test(unlist(P_ct),unlist(P_ds))$p.value,2))),
      side=3,line=-0.9,at=c(1.5,2.5))

rm(list=c("X","Z",grep("^temp",ls(),value=T)))
```

```{r noTS_diffexp_boxplot_v2, echo=F,message=F,warning=F,fig.height=4,fig.width=9}
temp_y <- lapply(c("P_all","P_ct","P_ds"),function(X) {
  temp <- -log10(unlist(get(X)))
  names(temp) <- sapply(strsplit(names(unlist(get(X))),".",fixed=T),"[[",1)
  return(temp)
})
temp_x <- sapply(list(ALL=de_all,CT=de_ct,DS=de_ds),function(DE)
  sapply(unlist(DE,recursive=F,use.names=F),length),simplify=F)

par(mfrow=c(1,4),mar=c(5,4,1,0.5),mgp=2:0)
boxplot(temp_y,ylim=range(temp_y),outline=T,xaxt="n",yaxt="n",ylab=NA)
text(c(1.5,2.5),line2user(-0.2,3),srt=90,adj=1,cex=1.2,
     labels=paste("p =",c(signif(wilcox.test(unlist(P_all),unlist(P_ct))$p.value,2),
                          signif(wilcox.test(unlist(P_ct),unlist(P_ds))$p.value,2))))
axis(2,cex.axis=1.2)
mtext("-log10(P # DE overlapping by chance)",side=2,line=2.5)
text(1:3,line2user(0.5,1),xpd=NA,srt=45,adj=1,cex=1.4,font=2,
     labels=c("Across all","Cell type","Lab"))

par(mar=c(5,0,1,0.5))
temp <- mapply(function(X,Y,N) {
  plot(NA,NA,xlim=range(X),ylim=range(temp_y),
       xaxt="n",yaxt="n",ylab=NA,xlab=NA)
  temp_X <- X; temp_Y <- Y
  temp_X[temp_X == 0] <- -abs(jitter(temp_X[temp_X == 0],amount=abs(par("usr")[1]) / 2))
  temp_Y[temp_Y == 0] <- -abs(jitter(temp_Y[temp_Y == 0],amount=abs(par("usr")[3]) / 2))
  points(temp_X,temp_Y,pch=19,cex=1.5,
         col=lig_col[names(temp_Y)])
  Z <- Y >= -log10(0.05)
  if (!any(Z)) { Z <- Y > 0 }
  temp_labels <- scClustViz::spreadLabels2(temp_X[Z],temp_Y[Z],label=names(temp_Y)[Z],
                                           str.cex=1.5,str.font=2)
  text(temp_labels,labels=names(temp_Y)[Z],cex=1.2,font=2,
       col=alpha(lig_col[names(temp_Y)[Z]],1))
  axis(1,cex.axis=1.2)
  mtext("# overlapping DE",side=1,line=2.5)
  mtext(N,side=1,line=4,font=2)
},X=temp_x,Y=temp_y,N=c("Pairwise across cell types / labs","Within same cell type","Same lab"))
```

