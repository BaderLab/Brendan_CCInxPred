---
title: "GSEA"
---
  
```{r setup, echo=F,message=F,warning=F}
library(scales)
library(colorspace)
source("~/Dropbox/GDB/line2user.R")
par(mar=c(3,3,2,1),mgp=2:0)
.PAR <- par(no.readonly=T)
knitr::opts_chunk$set(
  echo=F,
  message=F,
  warning=F
)
```

# Enrichment score correlation

```{r FX}
CORR_BXP <- function(Z) {
  files <- grep(paste0("_",Z,".RData$"),
                list.files("~/Dropbox/GDB_archive/CMapCorr_files/",pattern="^corrGSEA_[A-Z]"),
                value=T)
  for (GSEA in unique(sapply(strsplit(files,"_"),"[[",2))) {
    load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/corrGSEA_",GSEA,"_",Z,".RData"))
    
    temp_ds <- GSEA
    
    if (Z %in% c("ligct","rep")) {
      temp_lig <- as.factor(sub("_[A-Za-z0-9_]+$","",names(CORS)))
      temp_ord1 <- tapply(CORS,temp_lig,function(X) names(X)[order(sapply(X,median))])
      temp_ord2 <- order(tapply(CORS,temp_lig,function(X) median(unlist(X))))
      temp_order <- temp_ord1[temp_ord2]
      CORS <- CORS[unlist(temp_order)]
      temp_border <- qualitative_hcl(length(temp_order),palette="dark3")
      temp_border <- unlist(mapply(rep,
                                   x=temp_border,
                                   times=sapply(temp_order,length),
                                   SIMPLIFY=F))
      temp_col <- alpha(temp_border,0.5)
      temp_bot <- switch(1 + (length(temp_order) < 20),1.5,4)
    } else {
      temp_order <- order(sapply(CORS,median))
      CORS <- CORS[temp_order]
      temp_border <- qualitative_hcl(length(CORS),palette="dark3")
      temp_col <- qualitative_hcl(length(CORS),palette="dark3",alpha=0.5)
      temp_bot <- switch(1 + (length(CORS) < 20),1.5,4)
    }
    if (length(CORS) > 300) {
      temp_border <- alpha(temp_border,0.5)
      temp_col <- alpha(temp_col,0.2)
    }      
    par(mar=c(temp_bot,4,2,1),mgp=2:0)
    boxplot(CORS,outline=T,pch=".",xaxt="n",yaxs="i",ylim=c(-1,1),
            border=temp_border,col=temp_col,
            ylab=paste("Pairwise Spearman correlation of",
                       paste("Normalized Enrichment Score per",
                             switch(Z,
                                    lig="ligand",
                                    ct="cell line",
                                    ligct="ligand & cell line",
                                    rep="treatment condition")),
                       sep="\n"),
            main=temp_ds)
    if (length(CORS) > 300) {
      points(sapply(CORS,median),pch=".",col=alpha(temp_border,1))
    }
    abline(h=0,col="red",lty=2)
    if (temp_bot > 1.5) {
      if (Z %in% c("ligct","rep")) {
        mtext(names(temp_order),side=1,
              at=cumsum(sapply(temp_order,length)) - sapply(temp_order,length) / 2,
              las=2,xpd=NA,line=0.1,
              col=alpha(temp_border,1)[cumsum(sapply(temp_order,length))])
      } else {
        mtext(names(CORS),side=1,at=seq_along(CORS),
              las=2,xpd=NA,line=0.1,col=alpha(temp_border,1))
      }
    } else {
      mtext(switch(Z,
                   lig="Ligands",
                   ct="Cell lines",
                   ligct="Ligands per cell line",
                   rep="Treatment conditions"),
            side=1,line=0.2,cex=1.1,font=2)
    }
  }
}

```

Level 4 data (Z-scores) including inferred genes were used in GSEA analysis.  Pathway database was either GO-BP, Reactome, or All (`Human_GOBP_AllPathways_no_GO_iea_March_01_2021_entrezgene.gmt` from http://www.baderlab.org/GeneSets).  Inferred genes were included because without them, most pathways were not covered, which both artificially increased correlation of NES and drastically reduced power due to lack of genes.

Correlation of NES is a really dumb way of comparing enriched gene sets, but I already did the analysis, so here it is.


## GSEA correlation per cell line
```{r ct, fig.height=4,fig.width=9}
CORR_BXP("ct")
```


## GSEA correlation per ligand
```{r lig, fig.height=4,fig.width=9}
CORR_BXP("lig")
```


## GSEA correlation per ligand & cell line
```{r ligct, fig.height=4,fig.width=9}
CORR_BXP("ligct")
```


## GSEA correlation per treatment condition (replicate)
```{r rep, fig.height=4,fig.width=9}
CORR_BXP("rep")
```



## Comparison of all correlation distributions

As you can see, correlation of NES amongst replicates was the only thing that improved, which sort of makes sense as we don't expect low magnitude NES pathways to correlate at all.

```{r}
rm(list=ls())
```

```{r cors_per_lig, fig.height=4,fig.width=6}
source("~/Dropbox/GDB/line2user.R")

temp_GSEA <- unique(sapply(
  strsplit(list.files("~/Dropbox/GDB_archive/CMapCorr_files/",pattern="^corrGSEA_[A-Z]"),"_"),
  "[[",2))
for (GSEA in temp_GSEA) {
  
  temp <- load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/corrGSEA_",GSEA,"_lig.RData"))
  cor_lig <- get(temp)
  temp <- load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/corrGSEA_",GSEA,"_ligct.RData"))
  cor_ligct <- get(temp)
  temp <- load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/corrGSEA_",GSEA,"_rep.RData"))
  cor_rep <- get(temp)
  rm(list=c(temp,"temp"))
  
  
  cor_ligct_lig <- sapply(strsplit(names(cor_ligct),"_"),"[[",1)
  cor_rep_lig <- sapply(strsplit(names(cor_rep),"_"),"[[",1)
  
  diff_ligct <- sapply(names(cor_lig),function(LIG) 
    mean(unlist(cor_ligct[cor_ligct_lig == LIG])) - mean(cor_lig[[LIG]]))
  mean_ligct <- sapply(names(cor_lig),function(LIG) 
    mean(c(unlist(cor_ligct[cor_ligct_lig == LIG]),cor_lig[[LIG]])))
  
  diff_rep <- sapply(names(cor_lig),function(LIG) 
    mean(unlist(cor_rep[cor_rep_lig == LIG])) - mean(cor_lig[[LIG]]))
  mean_rep <- sapply(names(cor_lig),function(LIG) 
    mean(c(unlist(cor_rep[cor_rep_lig == LIG]),cor_lig[[LIG]])))
  
  
  layout(rbind(1:2),widths=c(1,2))
  
  par(mar=c(5,3,1,0),mgp=2:0)
  boxplot(list(diff_ligct,diff_rep),
          col=c("red","dodgerblue"),xaxt="n",
          ylab="Difference in mean vs. by ligand")
  text(c(1,2),rep(line2user(0.5,1),2),
       c("By ligand / cell line","By replicate"),
       adj=1,srt=45,xpd=NA,cex=0.8)
  abline(h=0,lty=2)
  if (wilcox.test(diff_ligct)$p.value < 2.2e-16) {
    mtext("*",side=3,at=1,line=-0.3)
  }
  if (wilcox.test(diff_rep)$p.value < 2.2e-16) {
    mtext("*",side=3,at=2,line=-0.3)
  }
  
  par(mar=c(5,0,1,1))
  plot(NA,NA,xlab=NA,ylab=NA,yaxt="n",
       xlim=range(c(mean_ligct,mean_rep)),ylim=range(diff_ligct,diff_rep))
  mtext(paste("Mean pairwise Spearman correlation of",
              paste0("GSEA Normalized Enrichment Score (",GSEA,")"),
              sep="\n"),
        side=1,line=3.2)
  abline(h=0,lty=2)
  points(mean_ligct,diff_ligct,pch=20,col=alpha("red",0.5))
  points(mean_rep,diff_rep,pch=20,col=alpha("dodgerblue",0.5))
  legend("bottomright",c("By ligand / cell line","By replicate"),
         pch=20,col=alpha(c("red","dodgerblue"),0.5),cex=0.8,bty="n")
  
}
```

****

# Overlap of enriched gene sets

```{r}
rm(list=ls())
source("~/Dropbox/GDB/line2user.R")

load("~/Dropbox/GDB_archive/CMapCorr_files/lvl5_inputs_allgenes.RData")
temp_ligcountsperct <- sapply(unique(lvl5_data@cdesc$cell_id),function(CT)
  length(unique(lvl5_data@cdesc[lvl5_data@cdesc$cell_id == CT,"pert_iname"])))
ct9 <- names(temp_ligcountsperct)[temp_ligcountsperct > 100]
names(ct9) <- sapply(ct9,function(X) names(ct14)[ct14 == X])

temp_ctcountsperlig <- sapply(unique(lvl5_data@cdesc$pert_iname),function(LIG)
  length(unique(lvl5_data@cdesc[lvl5_data@cdesc$pert_iname == LIG &
                                  lvl5_data@cdesc$cell_id %in% ct9,"cell_id"])))
lig295 <- names(temp_ctcountsperlig)[temp_ctcountsperlig == 9]
lig295 <- sort(lig295)

temp_id <- rownames(lvl5_data@cdesc)[lvl5_data@cdesc$pert_iname %in% lig295 & 
                                       lvl5_data@cdesc$cell_id %in% ct9]
lvl5_data@mat <- lvl5_data@mat[,temp_id]
lvl5_data@cdesc <- lvl5_data@cdesc[temp_id,]
lvl5_data@cid <- temp_id
rm(list=c("lig16","ct14",grep("^temp",ls(),value=T)))
```


```{r}
load("~/Dropbox/GDB_archive/CMapCorr_files/povlpGSEA_ALL.RData")

Roverlap_ct <-sapply(Noverlap_ct,function(X)
  sapply(colnames(X),function(CTname)
    X[,CTname] / sum(lvl5_data@cdesc$cell_id == ct9[CTname])
  ),simplify=F)

Roverlap_lig <-sapply(Noverlap_lig,function(X)
  sapply(colnames(X),function(LIG)
    X[,LIG] / sum(lvl5_data@cdesc$pert_iname == LIG)
  ),simplify=F)

Roverlap_ligct <-sapply(Noverlap_ligct,function(X)
  sapply(colnames(X),function(LIGCT) {
    temp <- strsplit(LIGCT,"_")[[1]]
    X[,LIGCT] / sum(lvl5_data@cdesc$pert_iname == temp[1] &
                    lvl5_data@cdesc$cell_id == temp[2])
  }),simplify=F)


```

```{r eval=F,fig.width=9,fig.height=9}
cutFDR <- names(Noverlap_ct)

par(mfcol=c(3,3),mar=c(3,3,2,1),mgp=2:0)
for (FDR in cutFDR) {
  plot(as.vector(Roverlap_ct[[FDR]]),
       as.vector(-log10(Poverlap_ct[[FDR]])),
       xlim=c(0,1),pch=".")
  plot(as.vector(Roverlap_lig[[FDR]]),
       as.vector(-log10(Poverlap_lig[[FDR]])),
       xlim=c(0,1),pch=".")
  plot(as.vector(Roverlap_ligct[[FDR]]),
       as.vector(-log10(Poverlap_ligct[[FDR]])),
       xlim=c(0,1),pch=".")
}

```


> This is per gene set, which is a weird way of thinking about it.

```{r fig.width=9,fig.height=6}
cutFDR <- names(Noverlap_ct)
temp_p <- c(1,.5,.1,.05,.01,.001,.0001)

par(mfrow=c(3,2),mar=c(3,3,2,1),mgp=2:0)
for (FDR in cutFDR) {
  boxplot(list(CT=-log10(Poverlap_ct[[FDR]]),
               Lig=-log10(Poverlap_lig[[FDR]]),
               LigCT=-log10(Poverlap_ligct[[FDR]])),
          pch=".",yaxt="n",main=paste0("FDR: 0.",FDR),
          ylab="P significant gene sets by chance")
  axis(2,at=-log10(temp_p),labels=temp_p)
  
  
  boxplot(list(CT=Roverlap_ct[[FDR]],
               Lig=Roverlap_lig[[FDR]],
               LigCT=Roverlap_ligct[[FDR]]),
          pch=".",ylab="Proportion of overlapping")
}

```

# Mean NES

```{r eval=F}
rm(list=ls())
source("~/Dropbox/GDB/line2user.R")

load("~/Dropbox/GDB_archive/CMapCorr_files/lvl4_inputs_allgenes.RData")
lvl4_data <- lvl4_data_all; rm(lvl4_data_all)
temp_ligcountsperct <- sapply(unique(lvl4_data@cdesc$cell_id),function(CT)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$cell_id == CT,"pert_iname"])))
ct9 <- names(temp_ligcountsperct)[temp_ligcountsperct > 100]
names(ct9) <- sapply(ct9,function(X) names(ct14)[ct14 == X])

temp_ctcountsperlig <- sapply(unique(lvl4_data@cdesc$pert_iname),function(LIG)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$pert_iname == LIG &
                                  lvl4_data@cdesc$cell_id %in% ct9,"cell_id"])))
lig295 <- names(temp_ctcountsperlig)[temp_ctcountsperlig == 9]
lig295 <- sort(lig295)

temp_id <- rownames(lvl4_data@cdesc)[lvl4_data@cdesc$pert_iname %in% lig295 & 
                                       lvl4_data@cdesc$cell_id %in% ct9]
lvl4_data@mat <- lvl4_data@mat[,temp_id]
lvl4_data@cdesc <- lvl4_data@cdesc[temp_id,]
lvl4_data@cid <- temp_id
rm(list=c("lig16","ct14",grep("^temp",ls(),value=T)))
```

```{r fig.height=3,fig.width=6}
load("~/Dropbox/GDB_archive/CMapCorr_files/GSEA_lvl4_GOBP.RData")

par(mar=c(3,3,1,1),mgp=2:0)
hist(sapply(gsea_nes_GOBP[-1],"[[","NES"),breaks=50,main=NA,xlab="GSEA NES")
rm(gsea_nes_GOBP)
```


```{r}
GSEA <- "GOBP"
# load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/pnesGSEA_",GSEA,".RData"))

load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/pnesGSEA_GOBP_backup.RData"))
```


```{r fig.height=3,fig.width=9}
FDRcut <- 0.0001

tempMAT <- Pscore_CT[apply(Pscore_CT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,6,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste(GSEA,"gene set enrichment"),side=1)
rm(list=grep("^temp",ls(),value=T))
```

```{r fig.height=6,fig.width=9}
tempMAT <- Pscore_Lig[,apply(Pscore_Lig,2,function(X) sum(abs(X) >= -log10(FDRcut)) >= 3)]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(1.5,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext("Ligands",side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
rm(list=grep("^temp",ls(),value=T))
```
```{r fig.height=9,fig.width=9}
tempMAT <- Pscore_LigCT[,apply(Pscore_LigCT,2,function(X) sum(abs(X) >= -log10(FDRcut)) >= 3)]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(1.5,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext("Ligands per cell line",side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
rm(list=grep("^temp",ls(),value=T))
```

```{r fig.height=3,fig.width=9}
par(mar=c(3,3,1,1),mgp=2:0)

boxplot(abs(Pscore_CT)[,order(colMeans(abs(Pscore_CT)))],
        pch=".",las=3,ylab="Mean NES |Significance|")
boxplot(abs(Pscore_Lig)[,order(colMeans(abs(Pscore_Lig)))],
        pch=".",las=3,xaxt="n",outline=F,
        xlab="Ligands",ylab="Mean NES |Significance|")
boxplot(abs(Pscore_LigCT)[,order(colMeans(abs(Pscore_LigCT)))],
        pch=".",las=3,xaxt="n",outline=F,
        xlab="Ligands per cell line",
        ylab="Mean NES |Significance|")


par(mfrow=c(1,2))
boxplot(list(CT=abs(Pscore_CT),
             Lig=abs(Pscore_Lig),
             LigCT=abs(Pscore_LigCT)),
        pch=".",horizontal=T,
        xlab="Mean NES |significance| (all)")
boxplot(list(CT=colMeans(abs(Pscore_CT)),
             Lig=colMeans(abs(Pscore_Lig)),
             LigCT=colMeans(abs(Pscore_LigCT))),
        pch=".",horizontal=T,
        xlab="Mean NES |significance| (means)")



```

# Mean signed FDR


```{r}
rm(list=ls())
source("~/Dropbox/GDB/line2user.R")

load("~/Dropbox/GDB_archive/CMapCorr_files/lvl4_inputs_allgenes.RData")
lvl4_data <- lvl4_data_all; rm(lvl4_data_all)
temp_ligcountsperct <- sapply(unique(lvl4_data@cdesc$cell_id),function(CT)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$cell_id == CT,"pert_iname"])))
ct9 <- names(temp_ligcountsperct)[temp_ligcountsperct > 100]
names(ct9) <- sapply(ct9,function(X) names(ct14)[ct14 == X])

temp_ctcountsperlig <- sapply(unique(lvl4_data@cdesc$pert_iname),function(LIG)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$pert_iname == LIG &
                                  lvl4_data@cdesc$cell_id %in% ct9,"cell_id"])))
lig295 <- names(temp_ctcountsperlig)[temp_ctcountsperlig == 9]
lig295 <- sort(lig295)

CID <- rownames(lvl4_data@cdesc)[lvl4_data@cdesc$pert_iname %in% lig295 & 
                                       lvl4_data@cdesc$cell_id %in% ct9]
CDESC <- lvl4_data@cdesc[CID,]

rm(list=c("lvl4_data","lig16","ct14",grep("^temp",ls(),value=T)))
```

Averaging "significance score" of each gene set across samples.  Score is `-log10(FDR) * sign(NES)`.  Example distribution:  

```{r fig.height=3,fig.width=6}
GSEA <- "GOBP"
load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/pfdrGSEA_",GSEA,".RData"))

par(mar=c(4,3,1,1),mgp=2:0)
hist(GSEA_score,breaks=50,main=NA,xlab=NA)
mtext(paste("GSEA signed significance score",
                "-log10(FDR) * sign(NES)",sep="\n"),
      side=1,line=3)
```

The following heatmaps are showing gene set enrichment per sample group (cell lines, ligands, or ligands per cell line).  Values are signed FDR-corrected p-values representing the likelihood of seeing as extreme a value by chance when averaging signed GSEA FDR values across the sample group.  

## Cell line  

```{r fig.height=3,fig.width=9}
temp_bad <- which(abs(Mscore_CT) == max(abs(Mscore_CT)[Qscore_CT > 0.9]),arr.ind=T)
temp_good <- which(abs(Mscore_CT) == max(abs(Mscore_CT)[Qscore_CT <= min(Qscore_CT)]),arr.ind=T)

temp_bxp <- list(GSEA_score[temp_bad[1],CDESC$cell_id != ct9[temp_bad[2]]],
                 GSEA_score[temp_bad[1],CDESC$cell_id == ct9[temp_bad[2]]],
                 NULL,
                 GSEA_score[temp_good[1],CDESC$cell_id != ct9[temp_good[2]]],
                 GSEA_score[temp_good[1],CDESC$cell_id == ct9[temp_good[2]]])

layout(rbind(1:2),widths=c(3,2))
par(mar=c(3,4,1,1),mgp=2:0)
boxplot(temp_bxp,horizontal=T,pch=".",xlab="Signed GSEA FDR",yaxt="n",
        col=c(rep("red",2),NA,rep("dodgerblue",2)))
mtext(rep(c("All","Samples"),2),side=2,las=2,line=0.1,at=c(1,2,4,5))
points(sapply(temp_bxp[c(2,5)],mean),c(2,5),pch=20,col="yellow")

par(mar=c(3,3,1,1),mgp=2:0)
plot(Mscore_CT,-log10(Qscore_CT),pch=".",
     xlab="Mean signed GSEA FDR",ylab="-log10(FDR-corrected p)")
points(Mscore_CT[temp_bad],-log10(Qscore_CT)[temp_bad],
       pch=20,col="red")
points(Mscore_CT[temp_good],-log10(Qscore_CT)[temp_good],
       pch=20,col="dodgerblue")

rm(list=grep("^temp",ls(),value=T))
```

```{r fig.height=3,fig.width=9}
FDRcut <- 0.01

tempMAT <- -log10(Qscore_CT) * sign(Mscore_CT)
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,6,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand  

```{r fig.height=3,fig.width=9}
temp_bad <- which(abs(Mscore_LIG) == max(abs(Mscore_LIG)[Qscore_LIG > 0.9]),arr.ind=T)
temp_good <- which(abs(Mscore_LIG) == max(abs(Mscore_LIG)[Qscore_LIG <= min(Qscore_LIG)]),arr.ind=T)

temp_bxp <- list(GSEA_score[temp_bad[1],CDESC$pert_iname != lig295[temp_bad[2]]],
                 GSEA_score[temp_bad[1],CDESC$pert_iname == lig295[temp_bad[2]]],
                 NULL,
                 GSEA_score[temp_good[1],CDESC$pert_iname != lig295[temp_good[2]]],
                 GSEA_score[temp_good[1],CDESC$pert_iname == lig295[temp_good[2]]])

layout(rbind(1:2),widths=c(3,2))
par(mar=c(3,4,1,1),mgp=2:0)
boxplot(temp_bxp,horizontal=T,pch=".",xlab="Signed GSEA FDR",yaxt="n",
        col=c(rep("red",2),NA,rep("dodgerblue",2)))
mtext(rep(c("All","Samples"),2),side=2,las=2,line=0.1,at=c(1,2,4,5))
points(sapply(temp_bxp[c(2,5)],mean),c(2,5),pch=20,col="yellow")

par(mar=c(3,3,1,1),mgp=2:0)
plot(Mscore_LIG,-log10(Qscore_LIG),pch=".",
     xlab="Mean signed GSEA FDR",ylab="-log10(FDR-corrected p)")
points(Mscore_LIG[temp_bad],-log10(Qscore_LIG)[temp_bad],
       pch=20,col="red")
points(Mscore_LIG[temp_good],-log10(Qscore_LIG)[temp_good],
       pch=20,col="dodgerblue")

# rm(list=grep("^temp",ls(),value=T))
```

```{r fig.height=6,fig.width=9}
tempMAT <- -log10(Qscore_LIG) * sign(Mscore_LIG)
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands (",ncol(tempMAT),"/",ncol(Mscore_LIG),")"),side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand per cell line  

```{r fig.height=3,fig.width=9}
temp_bad <- which(abs(Mscore_LIGCT) == max(abs(Mscore_LIGCT)[Qscore_LIGCT > 0.9]),arr.ind=T)
temp_good <- which(abs(Mscore_LIGCT) == 
                     max(abs(Mscore_LIGCT)[Qscore_LIGCT <= min(Qscore_LIGCT)]),arr.ind=T)
try({
  temp_bad <- temp_bad[1,,drop=F]
})
try({
  temp_good <- temp_good[1,,drop=F]
})
temp_bad_cl <- strsplit(colnames(Mscore_LIGCT)[temp_bad[2]],"_")[[1]]
temp_good_cl <- strsplit(colnames(Mscore_LIGCT)[temp_good[2]],"_")[[1]]

temp_bxp <- list(GSEA_score[temp_bad[1],
                            CDESC$cell_id != temp_bad_cl[1] &
                              CDESC$pert_iname != temp_bad_cl[2]],
                 GSEA_score[temp_bad[1],
                            CDESC$cell_id == temp_bad_cl[1] &
                              CDESC$pert_iname == temp_bad_cl[2]],
                 NULL,
                 GSEA_score[temp_good[1],
                            CDESC$cell_id != temp_good_cl[1] &
                              CDESC$pert_iname != temp_good_cl[2]],
                 GSEA_score[temp_good[1],
                            CDESC$cell_id == temp_good_cl[1] &
                              CDESC$pert_iname == temp_good_cl[2]])

layout(rbind(1:2),widths=c(3,2))
par(mar=c(3,4,1,1),mgp=2:0)
boxplot(temp_bxp,horizontal=T,pch=".",xlab="Signed GSEA FDR",yaxt="n",
        col=c(rep("red",2),NA,rep("dodgerblue",2)))
mtext(rep(c("All","Samples"),2),side=2,las=2,line=0.1,at=c(1,2,4,5))
points(sapply(temp_bxp[c(2,5)],mean),c(2,5),pch=20,col="yellow")

par(mar=c(3,3,1,1),mgp=2:0)
plot(Mscore_LIGCT,-log10(Qscore_LIGCT),pch=".",
     xlab="Mean signed GSEA FDR",ylab="-log10(FDR-corrected p)")
points(Mscore_LIGCT[temp_bad],-log10(Qscore_LIGCT)[temp_bad],
       pch=20,col="red")
points(Mscore_LIGCT[temp_good],-log10(Qscore_LIGCT)[temp_good],
       pch=20,col="dodgerblue")

# rm(list=grep("^temp",ls(),value=T))
```

```{r fig.height=6,fig.width=9}
tempMAT <- -log10(Qscore_LIGCT) * sign(Mscore_LIGCT)
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands per cell line (",
             length(unique(sub("^.+_","",colnames(tempMAT)))),
             "/295 unique ligands"),
      side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Compare  

Rather than comparing number of significant gene sets at a handful of FDR thresholds, we're using the KS-test to compare empirical cumulative distribution functions.  On the left are the ECDFs for the FDR-corrected p-values testing the null hypothesis that the signed "significance score" for each gene set averaged over the sample set (cell line, ligand, or ligand per cell line) could occur by chance, given the signed significance scores for each sample (tested by permuting sample labels).  On the right are ECDFs for the signed "significance score" for each gene set averaged over the sample set.  

```{r fig.height=4.5, fig.width=9, warning=FALSE}
allCuts <- seq(4,0,by=-0.01)
# layout(matrix(1:6,byrow=2,nrow=3),widths=c(3,2))
layout(rbind(1:2),widths=c(3,2))
par(mar=c(3,3,2,1),mgp=2:0)
# for (FN in list.files("~/Dropbox/GDB_archive/CMapCorr_files","^phits")) {
    # temp_gsea <- gsub("(phitsGSEA_)|(\\.RData)","",FN)
    # temp <- load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/",FN))
temp_gsea <- GSEA
temp <- load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/phitsGSEA_",GSEA,".RData"))    

    temp_max <- allCuts[min(sapply(list(NQhits_CT,NQhits_LIG,NQhits_LIGCT),
                                   function(X) which(colMeans(X) > 0)[1] - 1))]
    plot(allCuts,colMeans(NQhits_CT),xlim=c(0,temp_max),xaxt="n",
         type="l",lwd=2,col=qualitative_hcl(3,palette="dark3")[1],
         main=temp_gsea,xlab="Threshold of FDR-corrected P(mean signed GSEA FDR) by chance",
         ylab="Mean proportion of FDR \u2264 x for sample set averages")
    axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
         at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
    lines(allCuts,colMeans(NQhits_LIG),lwd=2,col=qualitative_hcl(3,palette="dark3")[2])
    lines(allCuts,colMeans(NQhits_LIGCT),lwd=2,col=qualitative_hcl(3,palette="dark3")[3])
    temp_c2l <- ks.test(colMeans(NQhits_CT),colMeans(NQhits_LIG))$p.value
    temp_l2lc <- ks.test(colMeans(NQhits_LIG),colMeans(NQhits_LIGCT))$p.value
    legend("topright",bty="n",lwd=rep(c(2,NA),3)[1:5],
           col=as.vector(sapply(qualitative_hcl(3,palette="dark3"),c,NA))[1:5],
           legend=c("CT",
                    switch(as.character(temp_c2l),
                           "0"="KS p \u003c 2.2e-16",
                           paste("KS p =",signif(temp_c2l,2))),
                    "LIG",
                    switch(as.character(temp_l2lc),
                           "0"="KS p \u003c 2.2e-16",
                           paste("KS p =",signif(temp_l2lc,2))),
                    "LIGCT"))
    
    temp_max <- allCuts[min(sapply(list(Nhits_CT,Nhits_LIG,Nhits_LIGCT),
                                   function(X) which(colMeans(X) > 0)[1] - 1))]
    plot(allCuts,colMeans(Nhits_CT),xlim=c(0,temp_max),xaxt="n",
         type="l",lwd=2,col=qualitative_hcl(3,palette="dark3")[1],
         main=temp_gsea,xlab="|Mean signed GSEA FDR| threshold",
         ylab="Mean proportion of sample set |mean signed FDR| \u2264 x")
    axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
         at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
    lines(allCuts,colMeans(Nhits_LIG),lwd=2,col=qualitative_hcl(3,palette="dark3")[2])
    lines(allCuts,colMeans(Nhits_LIGCT),lwd=2,col=qualitative_hcl(3,palette="dark3")[3])
    temp_c2l <- ks.test(colMeans(Nhits_CT),colMeans(Nhits_LIG))$p.value
    temp_l2lc <- ks.test(colMeans(Nhits_LIG),colMeans(Nhits_LIGCT))$p.value
    legend("topright",bty="n",lwd=rep(c(2,NA),3)[1:5],
           col=as.vector(sapply(qualitative_hcl(3,palette="dark3"),c,NA))[1:5],
           legend=c("CT",
                    switch(as.character(temp_c2l),
                           "0"="KS p \u003c 2.2e-16",
                           paste("KS p =",signif(temp_c2l,2))),
                    "LIG",
                    switch(as.character(temp_l2lc),
                           "0"="KS p \u003c 2.2e-16",
                           paste("KS p =",signif(temp_l2lc,2))),
                    "LIGCT"))

    rm(list=c(temp,grep("^temp",ls(),value=T)))
# }   
# rm(FN)
```

```{r eval=F}
temp <- load("~/Dropbox/GDB_archive/CMapCorr_files/phitsGSEA_GOBP.RData")

par(mfrow=c(3,1),mar=c(3,3,1,1),mgp=2:0)
hist(-log10(Phits_CT),breaks=50,xlim=c(0,4))
abline(v=mean(-log10(Phits_CT)),col="dodgerblue")
hist(-log10(Phits_LIG),breaks=50,xlim=c(0,4))
abline(v=mean(-log10(Phits_LIG)),col="dodgerblue")
hist(-log10(Phits_LIGCT),breaks=50,xlim=c(0,4))
abline(v=mean(-log10(Phits_LIGCT)),col="dodgerblue")

rm(list=c(temp,grep("^temp",ls(),value=T)))
```

As one might expect, averaging across fewer samples yields higher magnitude values.  

```{r fig.width=9,fig.height=4.5}
countsCT <- sapply(ct9,function(CT) sum(CDESC$cell_id == CT))
countsLIG <- sapply(lig295,function(LIG) sum(CDESC$pert_iname == LIG))
countsLIGCT <- as.vector(sapply(ct9,function(CT)
  sapply(lig295,function(LIG) 
    sum(CDESC$pert_iname == LIG & CDESC$cell_id == CT))))
names(countsLIGCT) <- as.vector(sapply(ct9,function(X) paste(X,lig295,sep="_")))


par(mfrow=c(1,2),mar=c(3,3,1.5,1),mgp=2:0)
plot(c(colMeans(abs(Mscore_CT)),colMeans(abs(Mscore_LIG)),colMeans(abs(Mscore_LIGCT))),
     c(countsCT,countsLIG,countsLIGCT),pch=".",cex=3,log="y",
     col=unlist(mapply(
       rep,
       x=qualitative_hcl(3,palette="dark3",alpha=0.8),
       times=sapply(list(countsCT,countsLIG,countsLIGCT),length)
     )),
     xlab="Gene set average |mean signed GSEA FDR|",
     ylab="Number of samples averaged (log scale)")
legend("topright",pch=20,bty="n",
       col=qualitative_hcl(3,palette="dark3",alpha=0.8),
       legend=c("CT","LIG","LIGCT"))
mtext(paste("Spearman correlation coefficient:",
            signif(
              cor(c(colMeans(abs(Mscore_CT)),colMeans(abs(Mscore_LIG)),colMeans(abs(Mscore_LIGCT))),
                  c(countsCT,countsLIG,countsLIGCT),method="spearman"),3
            )))

plot(c(colMeans(-log10(Qscore_CT)),colMeans(-log10(Qscore_LIG)),colMeans(-log10(Qscore_LIGCT))),
     c(countsCT,countsLIG,countsLIGCT),pch=".",cex=3,log="y",xaxt="n",
     col=unlist(mapply(
       rep,
       x=qualitative_hcl(3,palette="dark3",alpha=0.8),
       times=sapply(list(countsCT,countsLIG,countsLIGCT),length)
     )),
     xlab="Gene set average FDR(|mean signed GSEA FDR|)",
     ylab="Number of samples averaged (log scale)")
axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
     at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
legend("topright",pch=20,bty="n",
       col=qualitative_hcl(3,palette="dark3",alpha=0.8),
       legend=c("CT","LIG","LIGCT"))
mtext(paste("Spearman correlation coefficient:",
            signif(
              cor(c(colMeans(-log10(Qscore_CT)),colMeans(-log10(Qscore_LIG)),colMeans(-log10(Qscore_LIGCT))),
                  c(countsCT,countsLIG,countsLIGCT),method="spearman"),3
            )))
```

# Mean signed FDR (downsampled)  
Since number of samples being averaged was causing artifacts, downsampled to averaging 5 randomly selected samples from each sample set.  Repeated enough times to cover the largest set once.

```{r}
rm(list=ls())
source("~/Dropbox/GDB/line2user.R")
```

## Overall and within-set comparisons

Left: FDR-correction for all sample sets (ie. cell types / ligands) together, per downsample.  
Right: FDR-correction per sample set, per downsample.  

```{r fig.height=9,fig.width=9,warning=FALSE}
allCuts <- seq(4,0,by=-0.01)

par(mfrow=c(2,2),mar=c(3,3,2,1),mgp=2:0)
for (GSEA in c("REACT","GOBP")) {
  load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/pfdrGSEA_",GSEA,"_DS.RData"))
  
  temp_max <- allCuts[min(sapply(list(NQall_CT,NQall_LIG,NQall_LIGCT),
                                 function(X) which(colMeans(X) > 0)[1] - 1))]
  plot(NA,NA,xlim=c(0,temp_max),xaxt="n",ylim=c(0,1),main=GSEA,cex.lab=0.9,
       xlab="Threshold of FDR-corrected P(mean signed GSEA FDR) by chance",
       ylab="Mean proportion of FDR \u2264 x for sample set averages")
  axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
       at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
  temp <- apply(NQall_CT,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[1]))
  temp <- apply(NQall_LIG,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[2]))
  temp <- apply(NQall_LIGCT,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[3]))
  
  plot(NA,NA,xlim=c(0,temp_max),xaxt="n",ylim=c(0,1),main=GSEA,cex.lab=0.9,
       xlab="Threshold of FDR-corrected P(mean signed GSEA FDR) by chance",
       ylab="Mean proportion of FDR \u2264 x for sample set averages")
  axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
       at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
  temp <- apply(NQper_CT,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[1]))
  temp <- apply(NQper_LIG,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[2]))
  temp <- apply(NQper_LIGCT,1,function(X)
    lines(allCuts,X,lwd=2,col=qualitative_hcl(3,palette="dark3",alpha=0.5)[3]))
}
rm(list=grep("^temp",ls(),value=T))
```


```{r eval=F}
newCut <- seq(0.1,0.3,0.1)
CUT <- 0.1

# sapply(Qscore_LIG,function(X) rowMeans(X <= CUT))

temp_bxp <- list(CT=NQhits_CT[,which(allCuts == -log10(CUT))],
                 LIG=NQhits_LIG[,which(allCuts == -log10(CUT))],
                 LIGCT=NQhits_LIGCT[,which(allCuts == -log10(CUT))])
boxplot(temp_bxp,pch=20)
points(1:3,sapply(temp_bxp,mean),pch=19,col=alpha("red",0.5))

wilcox.test(temp_bxp$LIG,temp_bxp$LIGCT)

```


## Cell line  

```{r fig.height=3,fig.width=9}
FDRcut <- 0.9

tempMAT <- apply(
  sapply(seq_along(Qper_CT),function(X) 
    -log10(Qper_CT[[X]]) * sign(Mscore_CT[[X]]),
    simplify="array"),
  MARGIN=c(1,2),mean)
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,6,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand  

```{r fig.height=3,fig.width=9}
FDRcut <- 0.1

tempMAT <- apply(
  sapply(seq_along(Qper_LIG),function(X) 
    -log10(Qper_LIG[[X]]) * sign(Mscore_LIG[[X]]),
    simplify="array"),
  MARGIN=c(1,2),mean)
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,4,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands (",ncol(tempMAT),"/",length(Mscore_LIG),")"),side=2,line=3)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand per cell line  

```{r fig.height=6,fig.width=9}
tempMAT <- apply(
  sapply(seq_along(Qper_LIGCT),function(X) 
    -log10(Qper_LIGCT[[X]]) * sign(Mscore_LIGCT[[X]]),
    simplify="array"),
  MARGIN=c(1,2),mean)
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands per cell line (",
             length(unique(sub("^.+_","",colnames(tempMAT)))),
             "/295 unique ligands)"),
      side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```


# MeanZ GSEA

```{r}
rm(list=ls())
source("~/Dropbox/GDB/line2user.R")

load("~/Dropbox/GDB_archive/CMapCorr_files/lvl4_inputs_allgenes.RData")
lvl4_data <- lvl4_data_all; rm(lvl4_data_all)
temp_ligcountsperct <- sapply(unique(lvl4_data@cdesc$cell_id),function(CT)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$cell_id == CT,"pert_iname"])))
ct9 <- names(temp_ligcountsperct)[temp_ligcountsperct > 100]
names(ct9) <- sapply(ct9,function(X) names(ct14)[ct14 == X])

temp_ctcountsperlig <- sapply(unique(lvl4_data@cdesc$pert_iname),function(LIG)
  length(unique(lvl4_data@cdesc[lvl4_data@cdesc$pert_iname == LIG &
                                  lvl4_data@cdesc$cell_id %in% ct9,"cell_id"])))
lig295 <- names(temp_ctcountsperlig)[temp_ctcountsperlig == 9]
lig295 <- sort(lig295)

CID <- rownames(lvl4_data@cdesc)[lvl4_data@cdesc$pert_iname %in% lig295 & 
                                       lvl4_data@cdesc$cell_id %in% ct9]
CDESC <- lvl4_data@cdesc[CID,]

rm(list=c("lvl4_data","lig16","ct14",grep("^temp",ls(),value=T)))


GSEA <- "GOBP"
load(paste0("~/Dropbox/GDB_archive/CMapCorr_files/GSEA_meanZ_",GSEA,".RData"))
SCORE <- sapply(GSEA_MZ,function(X) -log10(sapply(X,"[[","padj")) * sign(sapply(X,"[[","NES")))

```

## Cell line

```{r fig.height=3,fig.width=9}
FDRcut <- 0.05

tempMAT <- SCORE[["ct"]]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,6,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand

```{r fig.height=6,fig.width=9}
tempMAT <- SCORE[["lig"]]
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands (",ncol(tempMAT),"/",ncol(SCORE[["lig"]]),")"),side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Ligand per cell line

```{r fig.height=6,fig.width=9}
tempMAT <- SCORE[["ligct"]]
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Ligands per cell line (",
             length(unique(sub("^.+_","",colnames(tempMAT)))),
             "/295 ligands represented at least once)"),
      side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Replicate

```{r fig.height=6,fig.width=9}
tempMAT <- SCORE[["rep"]]
tempMAT <- tempMAT[,apply(tempMAT,2,function(X) any(abs(X) >= -log10(FDRcut)))]
tempMAT <- tempMAT[apply(tempMAT,1,function(X) any(abs(X) >= -log10(FDRcut))),]
temp_lim <- max(abs(tempMAT))
temp_hSample <- hclust(dist(t(tempMAT)),method="ward.D2") 
temp_hSet <- hclust(dist(tempMAT),method="ward.D2")
tempMAT <- tempMAT[temp_hSet$order,temp_hSample$order]

par(mar=c(2,1.5,0.5,0.5))
image(z=tempMAT,x=1:nrow(tempMAT),y=1:ncol(tempMAT),
      col=diverging_hcl(1000,palette="Blue-Red3"),
      breaks=seq(-temp_lim,temp_lim,length.out=1001),
      xaxt="n",yaxt="n",xlab=NA,ylab=NA)
# mtext(colnames(tempMAT),side=2,line=0.1,at=1:ncol(tempMAT),las=2,cex=0.7)
mtext(paste0("Replicates (",
             length(unique(sapply(strsplit(colnames(tempMAT),"_"),"[[",1))),
             "/295 ligands represented at least once)"),
      side=2,line=0.1)
mtext(paste(GSEA,"gene set enrichment"),side=1)
mtext(paste0("|signed FDR| \u2264 ",FDRcut * 100,"%"),side=1,line=1)

rm(list=grep("^temp",ls(),value=T))
```

## Compare 

```{r fig.height=4.5,fig.width=8}
allCuts <- seq(3,0,by=-0.01)
NHITS <- sapply(SCORE,function(Z)
  sapply(allCuts,function(X) mean(abs(Z) >= X)))

par(mar=c(3,3,1,1),mgp=2:0)
plot(NA,NA,xlim=c(0,3),ylim=c(0,1),xaxt="n",
     xlab="FDR threshold for mean Z-score GSEA results",
         ylab="Mean proportion of FDR \u2264 x")
temp <- sapply(1:ncol(NHITS),function(X)
  lines(allCuts,NHITS[,X],lwd=2,
        col=qualitative_hcl(ncol(NHITS),palette="dark3")[X]))
legend("topright",legend=colnames(NHITS),bty="n",lwd=2,
       col=qualitative_hcl(ncol(NHITS),palette="dark3"))
axis(side=1,labels=c(.0001,.001,.01,.05,.1,.5,1),
     at=-log10(c(.0001,.001,.01,.05,.1,.5,1)))
```


